parameters:
- name: DartLabEnvironment
  displayName: DartLab Environment
  type: string
  default: Production
  values:
  - Production
  - Staging
- name: E2EPart1AgentCleanup
  displayName: Delete or keep E2E Part 1 machine for debugging
  type: string
  default: delete
  values:
  - delete
  - stop
- name: E2EPart2AgentCleanup
  displayName: Delete or keep E2E Part 2 machine for debugging
  type: string
  default: delete
  values:
  - delete
  - stop

extends:
  template: templates/pipeline.yml
  parameters:
    DartLabEnvironment: ${{parameters.DartLabEnvironment}}
    E2EPart1AgentCleanup: ${{parameters.E2EPart1AgentCleanup}}
    E2EPart2AgentCleanup: ${{parameters.E2EPart2AgentCleanup}}


  resources:
    pipelines:
    - pipeline: NuGet.Client-PrivateDev
      source: NuGet.Client-PrivateDev
      trigger:
      - dev

  jobs:
    - job: Static_Analysis
      displayName: "Static Analysis"
      timeoutInMinutes: 180
      pool: VSEngSS-MicroBuild2019-1ES

      steps:
        - task: CredScan@2
          inputs:
            toolMajorVersion: "V2"

        - task: SdtReport@1
          displayName: "Generate Analysis Report"
          inputs:
            CredScan: true
            ToolLogsNotFoundAction: "Standard"

        - task: TSAUpload@1
          displayName: "Upload to TSA"
          inputs:
            tsaVersion: "TsaV2"
            codebase: "$(TsaCodebase)"
            tsaEnvironment: "PROD"
            codeBaseName: "$(TsaCodebaseName)"
            notificationAlias: "$(TsaNotificationEmail)"
            codeBaseAdmins: "$(TsaCodebaseAdmins)"
            instanceUrlForTsaV2: "$(TsaInstanceUrl)"
            projectNameDEVDIV: "$(TsaProjectName)"
            areaPath: "$(TsaBugAreaPath)"
            iterationPath: "$(TsaIterationPath)"
            uploadAPIScan: false
            uploadBinSkim: false
            uploadCredScan: true
            uploadFortifySCA: false
            uploadFxCop: false
            uploadModernCop: false
            uploadPoliCheck: false
            uploadPREfast: false
            uploadRoslyn: false
            uploadTSLint: false
            uploadAsync: true

        - task: PublishSecurityAnalysisLogs@2
          displayName: "Publish CodeAnalysis Logs"
          inputs:
            ArtifactName: "CodeAnalysisLogs"
            ArtifactType: "Container"
            AllTools: false
            AntiMalware: false
            APIScan: false
            BinSkim: false
            CodesignValidation: false
            CredScan: true
            FortifySCA: false
            FxCop: false
            ModernCop: false
            MSRD: false
            PoliCheck: false
            RoslynAnalyzers: false
            SDLNativeRules: false
            Semmle: false
            TSLint: false
            WebScout: false
            ToolLogsNotFoundAction: "Standard"
